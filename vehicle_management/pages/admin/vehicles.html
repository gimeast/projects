<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="/src/css/style.css">
    <link rel="stylesheet" href="/src/css/pagination.css">
    <link rel="stylesheet" href="/src/css/admin-vehicle-list.css">
</head>
<body>
<header-component></header-component>

<div class="container">
    <div class="search">
        <label for="searchInput">검색</label>
        <input type="text" id="searchInput" placeholder="브랜드 | 모델 | 연식 | 구동방식 | 연료타입 | 미션타입">
        <button id="searchBtn">검색</button>
    </div>

    <div class="action-buttons">
        <button id="addBtn">차량 등록</button>
        <button id="deleteBtn">선택 차량 삭제</button>
    </div>

    <div class="vehicle-list-header">
        <div class="header-item">브랜드</div>
        <div class="header-item">모델</div>
        <div class="header-item">구동방식</div>
        <div class="header-item">연료타입</div>
        <div class="header-item">미션타입</div>
    </div>

    <div class="vehicle-list" id="vehicleList"></div>
    <div id="pagination" class="pagination"></div>
</div>

<!-- 차량 등록 모달 -->
<div class="modal-background" id="vehicleModal">
    <div class="modal-container">
        <div class="modal-header">
            <h2>차량 정보 등록</h2>
            <button class="modal-close" id="modalClose">&times;</button>
        </div>
        <div class="modal-body">
            <!-- 브랜드 -->
            <div class="form-group">
                <label for="brandInput">브랜드</label>
                <div class="input-wrapper">
                    <input type="text" id="brandInput">
                </div>
            </div>

            <!-- 모델 -->
            <div class="form-group">
                <label for="modelInput">모델</label>
                <div class="input-wrapper">
                    <input type="text" id="modelInput">
                </div>
            </div>

            <!-- 구동방식 -->
            <div class="form-group">
                <label for="drivetrainInput">구동방식</label>
                <div class="input-wrapper">
                    <input type="text" id="drivetrainInput">
                </div>
            </div>

            <!-- 연료타입 -->
            <div class="form-group">
                <label for="fuelTypeInput">연료타입</label>
                <div class="input-wrapper">
                    <input type="text" id="fuelTypeInput">
                </div>
            </div>

            <!-- 미션타입 -->
            <div class="form-group">
                <label for="transmissionInput">미션타입</label>
                <div class="input-wrapper">
                    <input type="text" id="transmissionInput">
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" id="cancelBtn">취소</button>
            <button class="btn-save" id="saveVehicleBtn">저장</button>
        </div>
    </div>
</div>


<script type="module" src="/src/components/header-component.js"></script>
<script type="module">
    import { getSpecList, saveSpec } from '/src/adminApi.js'
    import { renderPagination } from '/src/common/pagination-utils.js'

    let page = 1;
    let search = '';
    let totalPages = 1;
    const requiredFields = ['brand', 'model', 'drivetrain', 'fuelType', 'transmission'];

    function initPage() {
        document.getElementById('searchBtn').addEventListener('click', () => {
            search = document.getElementById('searchInput').value;
            page = 1;
            loadVehicles();
        });

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                search = e.target.value;
                page = 1;
                loadVehicles();
            }
        });

        document.getElementById('addBtn').addEventListener('click', () => {
            openModal();
        });
        document.getElementById('modalClose').addEventListener('click', () => {
            closeModal();
        });
        document.getElementById('cancelBtn').addEventListener('click', () => {
            closeModal();
        });

        document.getElementById('saveVehicleBtn').addEventListener('click', () => {
            saveVehicleInfo();
        });

        loadVehicles();
    }

    async function saveVehicleInfo() {

        try {
            requiredFields.forEach(field => {
                const inputValue = document.getElementById(`${field}Input`).value;

                if(inputValue.trim() === '') {
                    throw Error('모든 정보를 입력해주세요.');
                }
            });

            const brandName = document.getElementById('brandInput').value;
            const modelName = document.getElementById('modelInput').value;
            const drivetrain = document.getElementById('drivetrainInput').value;
            const fuelType = document.getElementById('fuelTypeInput').value;
            const transmission = document.getElementById('transmissionInput').value;

            const data = await saveSpec(brandName, modelName, drivetrain, fuelType, transmission);
            alert(data);

            closeModal();

        } catch(error) {
            alert(error.message);
            return;
        }

        await loadVehicles();
    }

    function openModal() {
        document.getElementById('vehicleModal').style.display = 'block';
    }

    function closeModal() {
        requiredFields.forEach(field => {
            document.getElementById(`${field}Input`).value = '';
        });

        document.getElementById('vehicleModal').style.display = 'none';
    }


    async function loadVehicles() {
        try {
            const data = await getSpecList(search, page);
            renderVehicleList(data.content);

            totalPages = data.totalPages || 1;
            renderPagination('pagination', page, totalPages, (newPage) => {
                page = newPage;
                loadVehicles();
            });

        } catch (error) {
            console.error('데이터 로드 중 오류 발생:', error);
            showError(error);
        }
    }

    function renderVehicleList(vehicles) {
        const vehicleList = document.getElementById('vehicleList');
        vehicleList.innerHTML = '';

        if (!vehicles || vehicles.length === 0) {
            vehicleList.innerHTML = '<div class="no-data">결과가 없습니다</div>';
            return;
        }

        vehicles.forEach(vehicle => {
            const brand = vehicle.brandDTO?.name || '';
            const model = vehicle.modelDTO?.name || '';
            const drivetrain = vehicle.trimDTO?.drivetrain || '';
            const fuelType = vehicle.trimDTO?.fuelType || '';
            const transmission = vehicle.trimDTO?.transmission || '';

            const vehicleItem = document.createElement('div');
            vehicleItem.className = 'vehicle-item';

            vehicleItem.innerHTML = `
                <div class="vehicle-data">${brand}</div>
                <div class="vehicle-data">${model}</div>
                <div class="vehicle-data">${drivetrain}</div>
                <div class="vehicle-data">${fuelType}</div>
                <div class="vehicle-data">${transmission}</div>
            `;

            vehicleItem.addEventListener('click', () => {
                window.location.href = `/admin/vehicles/${vehicle.trimDTO.idx}`;
            });

            vehicleList.appendChild(vehicleItem);
        });
    }

    function showError(error) {
        const vehicleList = document.getElementById('vehicleList');
        const errorMessage = error.response?.data?.message || error.message || '데이터를 불러오는 중 오류가 발생했습니다';
        vehicleList.innerHTML = `<div class="error-message">오류: ${errorMessage}</div>`;
    }

    document.addEventListener('DOMContentLoaded', initPage);
</script>

</body>
</html>